#!/usr/bin/env python3

import glob
import os
import sys

import cvelib.cve
from cvelib.common import (
    getConfigCveDataPath,
    getConfigCompatUbuntu,
    warn,
)


def main():
    path = getConfigCveDataPath()
    compatUbuntu = getConfigCompatUbuntu()

    # TODO: make configurable
    seen = {}
    active = os.path.join(path, "active")
    retired = os.path.join(path, "retired")
    ignored = os.path.join(path, "ignored")
    cves = (
        glob.glob(active + "/CVE*")
        + glob.glob(retired + "/CVE-*")
        + glob.glob(ignored + "/CVE-*")
    )
    cves.sort()
    for f in cves:
        tmp = os.path.realpath(f).split("/")
        rel = tmp[-2] + "/" + tmp[-1]
        try:
            cve = None
            cve = cvelib.cve.CVE(fn=f, compatUbuntu=compatUbuntu)
        except Exception as e:
            warn("%s: %s" % (rel, str(e)))
            continue

        # make sure the name of the file matches the candidate
        bn = os.path.basename(f)
        if bn != cve.candidate:
            warn("%s: non-matching candidate '%s'" % (rel, cve.candidate))

        if cve.candidate not in seen:
            seen[cve.candidate] = [rel]
        else:
            seen[cve.candidate].append(rel)
            warn(
                "multiple entries for %s: %s"
                % (cve.candidate, ", ".join(seen[cve.candidate]))
            )


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("Aborted.")
        sys.exit(1)
