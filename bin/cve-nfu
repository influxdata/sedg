#!/bin/bash
set -e

# HELPERS

help() {
    cat <<EOM
Usage: cve-nfu [-e FILENAME] CVE-YYYY-NNNN: Project Name
Usage: cve-nfu [-e FILENAME] -p PROJECT CVE-YYYY-NNN1 CVE-YYYY-NNN2

  -f FILENAME   file containing NFUs (default: ./ignored/not-for-us.txt)
  -e FILENAME   file containing known embedded projects. File contains a list
                of projects, one per line with empty lines and lines starting
                with '#' skipped
  -p PROJECT    project name to use when specifying a list of CVEs

Eg:

  $ cve-nfu CVE-2022-26336: Apache POI
  $ cve-nfu -e ./embedded CVE-2021-44521: Apache Cassandra
  $ cve-nfu -p "Apache Tiki" CVE-2022-25169 CVE-2022-30126 CVE-2022-33879
EOM
}

add_nfu() {
    local cve="$1"
    local proj="$2"

    cve=$(echo "$cve" | grep -E '^CVE-[0-9][0-9][0-9][0-9]-[0-9][0-9][0-9][0-9]+')
    if [ -z "$cve" ]; then
        echo "Malformed input. Should be 'CVE-YYYY-NNNN'" >&2
        exit 1
    elif grep -Eq "^$cve:" "$nfu" ; then
        echo "Skipping already existing $cve"
    elif [ -n "$emb" ] && grep -Eq "$proj" "$emb" ; then
        echo "Skipping '$proj' which is listed in $emb" >&2
    else
        echo "$cve: $proj" >> "$nfu"
    fi
}

# START

nfu="./ignored/not-for-us.txt"
emb=
proj=

while getopts "he:f:p:" opt
do
    case "$opt" in
        e) emb="$OPTARG";;
        f) nfu="$OPTARG";;
        p) proj="$OPTARG";;
        h) help ; exit 0;;
        ?) help;;
    esac
done
shift $((OPTIND - 1))

if [ ! -e "$nfu" ]; then
    echo "'$nfu' does not exist" >&2
fi

if [ -n "$emb" ] && [ ! -e "$emb" ]; then
    echo "'$emb' does not exist" >&2
fi

# CVE-YYYY-NNN1: Foo
if [ -z "$proj" ]; then
    proj=$(echo "$*" | cut -d ' ' -f 2-)
    cve=$(echo "$*" | grep -E '^CVE-.*+: ' | cut -d ':' -f 1)
    if [ -z "$cve" ]; then
        echo "Malformed input. Should be 'CVE-YYYY-NNNN: ...'" >&2
        exit 1
    fi
    add_nfu "$cve" "$proj"
else
    for cve in "$@" ; do
        # cve-nfu -p foo CVE-2018-12648, CVE-2021-36045, CVE-2021-36046
        add_nfu "${cve//,/}" "$proj"
    done
fi
