#!/bin/bash
set -e

# HELPERS

help() {
    cat <<EOM
Usage: cve-nfu [-e FILENAME] CVE-YYYY-NNNN: Project Name

  -f FILENAME   file containing NFUs (default: ./ignored/not-for-us.txt)
  -e FILENAME   file containing known embedded projects. File contains a list
                of projects, one per line with empty lines and lines starting
                with '#' skipped

Eg:

  $ cve-nfu CVE-2022-26336: Apache POI
  $ cve-nfu -e ./embedded CVE-2021-44521: Apache Cassandra
EOM
}

# START

nfu="./ignored/not-for-us.txt"
emb=

while getopts "he:f:" opt
do
    case "$opt" in
        e) emb="$OPTARG";;
        f) nfu="$OPTARG";;
        h) help ; exit 0;;
        ?) help;;
    esac
done
shift $((OPTIND - 1))

if [ ! -e "$nfu" ]; then
    echo "'$nfu' does not exist" >&2
fi

if [ -n "$emb" ] && [ ! -e "$emb" ]; then
    echo "'$emb' does not exist" >&2
fi

cve=$(echo "$*" | grep -E '^CVE-[0-9][0-9][0-9][0-9]-[0-9][0-9][0-9][0-9]+: ' | cut -d ':' -f 1)
proj=$(echo "$*" | cut -d ' ' -f 2-)
if [ -z "$cve" ]; then
    echo "Malformed input. Should be 'CVE-YYYY-NNNN: ...'" >&2
    exit 1
elif grep -Eq "^$cve:" "$nfu" ; then
    echo "Skipping already existing $cve"
elif [ -n "$emb" ] && grep -Eq "$proj" "$emb" ; then
    echo "Skipping '$proj' which is listed in $emb" >&2
else
    echo "$*" >> "$nfu"
fi
