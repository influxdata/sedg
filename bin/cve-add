#!/usr/bin/env python3

import argparse
import os
import shutil
import sys
import tempfile

import cvelib.cve
from cvelib.common import (
    CveException,
    getConfigCveDataPath,
    getConfigCompatUbuntu,
    readCve,
    # warn,
    error,
)


def createCve(path, cve_path, cve, cand, args_pkgs, compatUbuntu, append=False):
    """Create CVE from boilerplate"""
    pkgs = []
    if args_pkgs is not None:
        for p in args_pkgs:
            # mock up an entry
            pkgs.append("%s: needed" % p)

    # find boiler
    boiler = os.path.join(path, "active", "00boilerplate")
    if not os.path.isfile(boiler):
        raise CveException("could not find '%s'" % boiler)

    data = {}
    if append:
        data = readCve(cve_path)
    else:
        data = readCve(boiler)

    # fill in the CVE
    refs = []
    bugs = []
    if cve.startswith("http"):
        refs.append(cve)
        bugs.append(cve)
        data["Bugs"] = " ".join(bugs)
    else:
        refs.append("https://cve.mitre.org/cgi-bin/cvename.cgi?name=%s" % cve)

    data["Candidate"] = cand
    data["References"] = " ".join(refs)

    # If we can detect it, add the package from the url
    if not append and "-GH" in cand and "#" in cand:
        parsed_pkg = cand.split("#")[1]
        s = "git/github_%s: needed" % parsed_pkg
        if s not in pkgs:
            pkgs.insert(0, s)

    pkgObjs = []
    for pkg in pkgs:
        pkgObjs.append(cvelib.pkg.parse(pkg))

    cveObj = cvelib.cve.CVE(compatUbuntu=compatUbuntu)
    cveObj._setFromData(data, untriagedOk=True)
    if pkgObjs:
        cveObj.setPackages(pkgObjs, append=append)

    # now write it out
    with tempfile.NamedTemporaryFile(mode="w", delete=False) as f:
        f.write(cveObj.onDiskFormat())
        f.flush()
        shutil.copyfile(f.name, cve_path, follow_symlinks=False)
        os.unlink(f.name)


def main():
    path = getConfigCveDataPath()
    compatUbuntu = getConfigCompatUbuntu()

    parser = argparse.ArgumentParser(
        prog="cve-add",
        description="Add CVE to tracker",
    )
    parser.add_argument(
        "-c",
        "--cve",
        dest="cve",
        help="CVE entry",
        metavar="CVE-YYYY-NNNN|CVE-YYYY-GHNNNN#PROJECT",
    )
    parser.add_argument(
        "-p",
        "--package",
        dest="pkgs",
        help="Package (project) name",
        metavar="PKGNAME|CVE-YYYY-GHNNNN#PROJECT",
        action="append",
    )
    args = parser.parse_args()

    if not args.cve:
        error("missing required argument: --cve")

    cand = None
    if args.cve.startswith("http"):
        cand = cvelib.cve.CVE().cveFromUrl(args.cve)
    else:
        cand = args.cve
        if not args.pkgs:
            error("missing required argument: --package")

    cve_fn = os.path.join(path, "active", cand)  # TODO: check retired, ...
    if os.path.isfile(cve_fn):
        createCve(path, cve_fn, args.cve, cand, args.pkgs, compatUbuntu, append=True)
    else:
        createCve(path, cve_fn, args.cve, cand, args.pkgs, compatUbuntu, append=False)


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("Aborted.")
        sys.exit(1)
